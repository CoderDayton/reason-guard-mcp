name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen --dev

      - name: Run ruff check
        run: uv run ruff check src/ tests/

      - name: Run ruff format check
        run: uv run ruff format --check src/ tests/

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen --dev

      - name: Run bandit security scan
        run: uv run bandit -c pyproject.toml -r src/

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen --dev

      - name: Run mypy
        run: uv run mypy src/ --ignore-missing-imports

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen --dev

      - name: Run tests with coverage
        run: uv run pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=90

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, security, typecheck, test]
    steps:
      - uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Build package
        run: uv build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/
          retention-days: 7

  changelog:
    name: Changelog Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: Check CHANGELOG.md has unreleased changes
        run: |
          if ! grep -q "## \[Unreleased\]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md must have an [Unreleased] section"
            exit 1
          fi

          # Extract content between [Unreleased] and next ## or ---
          UNRELEASED=$(sed -n '/## \[Unreleased\]/,/^## \[/p' CHANGELOG.md | sed '1d;$d' | grep -v '^$' | grep -v '^---' || true)

          if [ -z "$UNRELEASED" ]; then
            echo "::warning::CHANGELOG.md [Unreleased] section is empty. Consider documenting your changes."
          else
            echo "âœ“ CHANGELOG.md has unreleased changes:"
            echo "$UNRELEASED"
          fi

  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6

      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --frozen --dev

      - name: Run benchmark
        run: |
          uv run python examples/benchmark.py --export benchmark_results.json
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat benchmark_results.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for performance regression
        run: |
          # Extract p95 latencies from benchmark results
          CHAIN_P95=$(jq -r '.results[] | select(.name=="chain_workflow") | .latency.p95_ms // empty' benchmark_results.json)
          COMPRESS_P95=$(jq -r '.results[] | select(.name=="compress_latency") | .latency.p95_ms // empty' benchmark_results.json)

          # Validate results exist
          if [ -z "$CHAIN_P95" ]; then
            echo "::error::chain_workflow benchmark result not found"
            exit 1
          fi
          if [ -z "$COMPRESS_P95" ]; then
            echo "::error::compress_latency benchmark result not found"
            exit 1
          fi

          # Baseline thresholds (fail if p95 exceeds these by >20%)
          CHAIN_BASELINE=25.0
          COMPRESS_BASELINE=10.0

          echo "Chain workflow p95: ${CHAIN_P95}ms (baseline: ${CHAIN_BASELINE}ms)"
          echo "Compress p95: ${COMPRESS_P95}ms (baseline: ${COMPRESS_BASELINE}ms)"

          # Check regression (allow 20% variance for CI environment)
          CHAIN_THRESHOLD=$(echo "$CHAIN_BASELINE * 1.2" | bc)
          COMPRESS_THRESHOLD=$(echo "$COMPRESS_BASELINE * 1.2" | bc)

          if (( $(echo "$CHAIN_P95 > $CHAIN_THRESHOLD" | bc -l) )); then
            echo "::warning::Chain workflow p95 (${CHAIN_P95}ms) exceeds threshold (${CHAIN_THRESHOLD}ms)"
          fi

          if (( $(echo "$COMPRESS_P95 > $COMPRESS_THRESHOLD" | bc -l) )); then
            echo "::warning::Compress p95 (${COMPRESS_P95}ms) exceeds threshold (${COMPRESS_THRESHOLD}ms)"
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: benchmark_results.json
          retention-days: 30

  docker:
    name: Docker Build & Sign
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for keyless signing with Sigstore

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign container image with cosign (keyless)
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          # Sign all tags with keyless signing (uses GitHub OIDC)
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}

      - name: Verify signature
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            ghcr.io/${{ github.repository }}@${DIGEST}
